jQuery(function(e){e.fn.fcbkcomplete=function(C){var v=e.isArray(C.used_vals)?C.used_vals:[];return this.each(function(){function y(){setTimeout(function(){var b=m.prev(),a=b.position();m.css({top:a.top+b.outerHeight(true),position:"absolute",left:a.left})},0)}function I(b,a){c.connect_with&&e(c.connect_with).each(function(){if(this!=k[0]){var d=e(this).data("setSelected");typeof d=="function"&&d(b,a)}})}function S(b){var a=0,d=e(b);e("div").each(function(){var h=parseInt(e(this).css("z-index")); if(d[0]!=this&&h>a)a=h});d.css({"z-index":a+1})}function T(){c.data&&e.isArray(c.data)?e.each(c.data,function(b,a){q.push({caption:a.name,value:a.id})}):k.children("option").each(function(b,a){a=e(a);if(a.hasClass("selected")||a.is(":selected")){w(a.text(),a.val(),true,a.hasClass("locked"));a.attr("selected","selected")}else a.removeAttr("selected");q.push({caption:a.text(),value:a.val()});x+=""+(q.length-1)+":"+a.text()+";"})}function w(b,a,d,h,r){if(!J())return false;var j=document.createElement("li"), z=document.createTextNode(b),l=document.createElement("a");h="bit-box"+(h?" locked":"");e(j).attr({"class":h,rel:a});e(j).prepend(z);e(l).attr({"class":"closebutton",href:"#"});j.appendChild(l);o.append(j);e(l).click(function(){K(e(this).parent("li"));return false});if(!d){D.remove();L(r);if(k.children("option[value="+a+"]").length){d=k.children("option[value="+a+"]");d.get(0).setAttribute("selected","selected");d.hasClass("selected")||d.addClass("selected")}else{d=e(document.createElement("option")); d.attr("value",a).get(0).setAttribute("selected","selected");d.attr("value",a).addClass("selected");d.text(b);k.append(d)}if(c.connect_with=="Array"&&e.inArray(a,v)<0)v.push(a.toString());else c.connect_with&&c.connect_with!="Array"&&I(a.toString(),true);typeof c.onselect=="function"&&M(c.onselect,d);k.change()}o.children("li.bit-box.deleted").removeClass("deleted");f.hide();s&&t.hide()}function K(b){if(!b.hasClass("locked")){b.fadeOut("fast");var a=b.attr("rel");if(c.connect_with=="Array"){var d= e.inArray(a,v);d>-1&&v.splice(d,1)}else c.connect_with&&c.connect_with!="Array"&&I(a,false);if(typeof c.onremove=="function"){a=k.children("option[value="+a+"]");M(c.onremove,a)}k.children('option[value="'+b.attr("rel")+'"]').removeAttr("selected").removeClass("selected");b.remove();k.change();E=0}}function L(b){var a=D=e(document.createElement("li"));n=e(document.createElement("input"));var d=0;a.attr({"class":"bit-input",id:u+"_annoninput"});n.attr({type:"text","class":"maininput",size:"1"});o.append(a.append(n)); n.focus(function(){m.fadeIn("fast")});n.blur(function(){m.fadeOut("fast")});o.click(function(){y();if(f.length&&(n.val().length||c.default_search.length)){if(c.default_search.length&&!n.val().length){n.focus();n.keyup()}f.show()}else{f.hide();s&&t.hide();m.children(".default").show()}});n.keypress(function(h){if(h.keyCode==13||h.keyCode==9)return false;n.attr("size",n.val().length+1)});n.keydown(function(h){if(h.keyCode==191){h.preventDefault();return false}});n.keyup(function(h){var r=n.val(),j= N(r==""?c.default_search:r);if(h.keyCode==8&&j.length==0){f.hide();s&&t.hide();if(!o.children("li.bit-box:last").hasClass("locked"))if(o.children("li.bit-box.deleted").length==0){o.children("li.bit-box:last").addClass("deleted");return false}else{if(E)return;E=1;o.children("li.bit-box.deleted").fadeOut("fast",function(){K(e(this));return false})}}if(h.keyCode!=40&&h.keyCode!=38&&j.length!=0){A=0;if(c.json_url)if(c.cache&&O){F(j);G()}else{d++;var z=d;setTimeout(function(){if(z==d)e.getJSON(c.json_url+ (c.json_url.indexOf("?")>-1?"&":"?")+"tag="+j,null,function(H){F(j,H);O=true;G()})},c.delay)}else{var l=undefined;if(c.preset_update){l=[];k.children("option").each(function(H,p){p=e(p);p.is(":selected")||p.is(".selected")||l.push({caption:p.text(),value:p.val()})})}F(j,l);G()}y();m.children(".default").hide();f.show()}});b&&setTimeout(function(){n.focus();y();m.children(".default").show()},1)}function F(b,a){f.html("");b=b==""?c.default_search:b;if(!c.cache&&a!=null){q=[];x=""}c.default_search!= b&&U(b);a!=null&&a.length&&e.each(a,function(H,p){q.push({caption:p.caption,value:p.value});x+=""+(q.length-1)+":"+p.caption+";"});var d=c.maxshownitems<q.length?c.maxshownitems:q.length,h="i";if(c.filter_case)h="";var r,j;try{r=eval("/(?:^|;)\\s*(\\d+)\\s*:[^;]*?"+b+"[^;]*/g"+h);j=r.exec(x)}catch(z){}for(h="";j!=null&&d>0;){j=q[j[1]];var l=e.inArray(j.value.toString(),B);if(l<0&&c.connect_with=="Array")l=e.inArray(j.value.toString(),v);if(l<0){l=k.children("option[value="+j.value+"]");if(l.length== 0)l=k.children(":contains('"+j.value+"')");l=l.length>0&&c.filter_selected&&(l.is(".selected")||l.is(":selected"))}else l=true;if(!l){h+='<li rel="'+j.value+'">'+V(j.caption,b)+"</li>";A++;d--}j=r.exec(x)}f.append(h);if(c.firstselected){g=f.children("li:visible:first");g.addClass("auto-focus")}if(A>c.height){f.css({height:c.height*24+"px",overflow:"auto"});s&&t.css({height:c.height*24+"px",width:f.width()+"px"}).show()}else{f.css("height","auto");s&&t.css({height:f.height()+"px",width:f.width()+"px"}).show()}} function V(b,a){if(c.filter_case)try{eval("var text = text.replace(/(.*)("+a+")(.*)/gi,'$1<em>$2</em>$3');")}catch(d){}else try{eval("var text = text.replace(/(.*)("+a.toLowerCase()+")(.*)/gi,'$1<em>$2</em>$3');")}catch(h){}return b}function P(){f.children("li").mouseover(function(){f.children("li").removeClass("auto-focus");e(this).addClass("auto-focus");g=e(this)});f.children("li").mouseout(function(){e(this).removeClass("auto-focus");g=null})}function Q(){f.children("li").unbind("mouseover");f.children("li").unbind("mouseout"); f.mousemove(function(){P();f.unbind("mousemove")})}function G(){var b=D.children(".maininput");P();f.children("li").unbind("mousedown");f.children("li").mousedown(function(){var a=e(this);w(a.text(),a.attr("rel"));f.hide();s&&t.hide();m.hide()});b.unbind("keydown");b.keydown(function(a){if(a.keyCode==191){a.preventDefault();return false}a.keyCode!=8&&o.children("li.bit-box.deleted").removeClass("deleted");if((a.keyCode==13||a.keyCode==9)&&R()){var d=g;w(d.text(),d.attr("rel"));m.hide();a.preventDefault(); g=null;return false}if((a.keyCode==13||a.keyCode==9)&&!R()){if(c.newel){d=N(e(this).val());w(d,d);m.hide();a.preventDefault();g=null}return false}if(a.keyCode==40){Q();if(g==null||g.length==0){g=f.children("li:visible:first");f.get(0).scrollTop=0}else{g.removeClass("auto-focus");g=g.nextAll("li:visible:first");d=parseInt(g.prevAll("li:visible").length,10);var h=parseInt(g.nextAll("li:visible").length,10);if((d>Math.round(c.height/2)||h<=Math.round(c.height/2))&&typeof g.get(0)!="undefined")f.get(0).scrollTop= parseInt(g.get(0).scrollHeight,10)*(d-Math.round(c.height/2))}f.children("li").removeClass("auto-focus");g.addClass("auto-focus")}if(a.keyCode==38){Q();if(g==null||g.length==0){g=f.children("li:visible:last");f.get(0).scrollTop=parseInt(g.get(0).scrollHeight,10)*(parseInt(f.children("li:visible").length,10)-Math.round(c.height/2))}else{g.removeClass("auto-focus");g=g.prevAll("li:visible:first");d=parseInt(g.prevAll("li:visible").length,10);h=parseInt(g.nextAll("li:visible").length,10);if((h>Math.round(c.height/ 2)||d<=Math.round(c.height/2))&&typeof g.get(0)!="undefined")f.get(0).scrollTop=parseInt(g.get(0).scrollHeight,10)*(d-Math.round(c.height/2))}f.children("li").removeClass("auto-focus");g.addClass("auto-focus")}})}function J(){if(c.maxitems!=0)return o.children("li.bit-box").length<c.maxitems?true:false}function U(b){if(c.newel&&J()){f.children("li[fckb=1]").remove();if(b.length!=0){var a=e(document.createElement("li"));a.attr({rel:b,fckb:"1"}).html(b);f.prepend(a);A++}}}function M(b,a){var d="";for(i= 0;i<a.get(0).attributes.length;i++)if(a.get(0).attributes[i].nodeValue!=null)d+='"_'+a.get(0).attributes[i].nodeName+'": "'+a.get(0).attributes[i].nodeValue+'",';d="{"+d+" notinuse: 0}";b.call(b,d)}function R(){if(g==null)return false;if(g.length==0)return false;return true}function N(b){b=b.replace(/[\"\'][\s]*javascript:(.*)[\"\']/g,'""');b=b.replace(/script(.*)/g,"");b=b.replace(/eval\((.*)\)/g,"");return b=b.replace("/([\u0000-\u0008,\u000b-\u000c,\u000e-\u0019])/","")}e(this).bind("addItem", function(b,a){w(a.title,a.value,0,0,0)});var c=e.extend({json_url:null,cache:false,height:"10",newel:false,firstselected:false,filter_case:false,filter_hide:false,complete_text:"Start to type...",default_search:".*?",maxshownitems:30,preset_update:true,maxitems:10,data:false,connect_with:false,onselect:"",onremove:"",delay:350},C),o=null,f=null,m=null,A=0,q=[],O=false,x="",g=null,E=0,s=false,t,k=e(this),u=k.attr("id"),D=null,n=null,B=[];u=u!=""&&u!=null?u:"fcbkselect_"+Math.floor(Math.random()*1E5); (function(){k.hide();k.attr("multiple","multiple");k.attr("name").indexOf("[]")==-1&&k.attr("name",k.attr("name")+"[]");o=e(document.createElement("ul"));o.attr("class","holder");k.after(o);m=e(document.createElement("div"));m.addClass("facebook-auto");m.append('<div class="default">'+c.complete_text+"</div>");if(s){m.append('<iframe class="ie6fix" scrolling="no" frameborder="0"></iframe>');t=m.children(".ie6fix")}f=e(document.createElement("ul"));f.attr("id",u+"_feed");m.prepend(f);o.after(m);f.css({position:"absolute", width:m.width()});T();y();L(0);S(m.parent());k.data("setSelected",function(b,a){var d=e.inArray(b,B);if(a&&d<0)B.push(b);else!a&&d>-1&&B.splice(d,1)})})();return this})}});